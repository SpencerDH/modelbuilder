# modelbuilder package information

## Package coding conventions
* The name of the non-reactive modelbuilder object must be mbmodel
* The name of a reactive modelbuilder object must be dynmbmodel
* To avoid variable naming conflicts with users, we should use internal variable names that are unique. Suggestion is NN_mb.


## Current package structure 
* Currently, user loads package, starts main menu with `modelbuilder()`
* Main menu lets users build a new model, load an existing model, modify or analyze existing model, export code for existing model, and do import/export to SBML. Only some of the features are currently implemented/working.
* Each model is saved as list structure called 'model' and stored in Rdata files.
* Several functions take the model structure and turn it into R code/functions for implementing the model as ODE, stochastic/adaptivetau, discrete time, RxODE, SBML, etc. (only some implemented yet)
* As model is built, a diagram is drawn 
* As model is built, equations are written to screen as Latex/shiny output object 
* When user saves model, the model is written to an Rdata file



## Package functionality requirements
* Users need to be able to build and analyze compartmental models without coding
* Ideally, the building and analysis/testing need to happen at the same time so users can test their model behavior as they build it to see if it works
* Things need to be reversible, i.e. for each compartment/variable and each inflow/outflow term, users need to be able to add/remove/edit
* Ideally, as model is being built, it should interactively show diagram and differential equations, as well as inputs for initial conditions and parameters so a user can run it.
* Users should be able to save models, load and modify models, import and export models
* The package needs to have lots of checks to make sure user doesn't do something detrimental
* Package also needs to have lots of internal (unit) tests (using testthat)




## Specific thoughts
* The generate_discrete and other functions create internal variables in the code, e.g. 'ts'. If a user happens to call one of their variables/compartments the same name, problems likely arise. Might have to rename our internal variables to something unlikely to conflict (e.g. ts_mb) and/or implement checks to prevent use of certain names.


## modelbuilder Model structure
We'll store a model as a list, and save it as Rdata file. 


The model list will have the components described below.
The following constraints are currently imposed:

* Variable names have to start with an upper-case letter and can only contain letters and numbers
* Parameter names have to start with a lower-case letter and can only contain letters and numbers



### Meta-Information
* `mbmodel$title` - model title
* `mbmodel$description` - a short (1 sentence) model description
* `mbmodel$author` - name of model author/creator
* `mbmodel$date` - date of creation or last change
* `mbmodel$details` - a detailed model description

### Variable information
* `mbmodel$var[[i]]$varname` - characters containing variable name, string
* `mbmodel$var[[i]]$vartext` - description of variable, string
* `mbmodel$var[[i]]$varval` - starting value, numeric
* `mbmodel$var[[i]]$flows` - all flow terms, as vector of strings
* `mbmodel$var[[i]]$flownames` - description of each flow, vector of strings

i = 1..number of variables

### Parameter information
* `mbmodel$par[[i]]$parname` - parameter name
* `mbmodel$par[[i]]$partext` - description of parameter 
* `mbmodel$par[[i]]$parval` - default value 

i = 1..number of parameters

### Time information
* `mbmodel$time[[i]]$timename` - tstart/tfinal/dt (fixed names, in that order)
* `mbmodel$time[[i]]$timetext` - text  
* `mbmodel$time[[i]]$timeval` - default value

i = 1,2,3 being tstart, tfinal and dt


### Optional/for later:
* `mbmodel$par[[i]]$lb` - lower bound for parameter 
* `mbmodel$par[[i]]$ub` - upper bound for parameter 

### Model examples
Several model examples following the above structure (and currently generated by hand with the XX_model_object.R scripts) are in the `\inst\modelexamples` folder

## Information for package development

### To work on package through RStudio: 
* Load project file in RStudio. Edit files as needed.
* Optionally, use RStudio tie-in with github to sync project to github (the 'git' tab).

### Dependency packages for development
* roxygen
* devtools
* testthat
* codecov
* rmarkdown for vignette and shiny documentation
* pkgdown for package doc site
* packages needed: see DESCRIPTION file
* Rtools needs to be installed (on Windows)
* All libraries/packages needed by this one should be loaded via the DESCRIPTION file and not in separate R files

### To update R documentation and vignette
* Edit documentation inside R functions. 
* Build documentation with More/Document or devtools::document()
* Edit vignette inside the /vignettes folder.
* To build new vignette, run devtools::build_vignettes()
* To update the pkgdown website, run pkgdown::build_site()



### To build the package
* "by hand" edit the DESCRIPTION file to make sure it's up to date
* in RStudio, use the functions in the 'build' tab to test and build the package.
* Run clean and rebuild, then build and reload using menu, or devtools::load_all()
* Run the check, fix any errors 

### To-do at release time 
* Re-build documentation, re-build package
* Re-build vignettes with devtools::build_vignettes()
* Run check and make sure no problems occur
* Re-create package site with pkgdown::build_site()
* Sync everything to github
* Check vignette and function references on website, fix errors
* Run check_rhub() and check_win_devel()
* Do a test run of devtools::release()



## Resources
A good source of shiny examples and tips and tricks that might be helpful:
https://deanattali.com/blog/advanced-shiny-tips/
https://shiny.rstudio.com/articles/dynamic-ui.html
